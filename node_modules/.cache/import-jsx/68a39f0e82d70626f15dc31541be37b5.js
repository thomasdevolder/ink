'use strict';

var utils = require('readline-utils');

var repeat = require('repeat-string');

const SnakeComp = ({
  emoji
}) => {
  var windowSize = require('window-size');

  var size = windowSize.height - 10;
  var score = 0;
  var head = '^';
  var body = []; // borders are from cli-table chars: https://github.com/Automattic/cli-table/blob/master/lib/index.js#L21-L37

  var borders = {
    'top': '─',
    'top-mid': '┬',
    'top-left': '┌',
    'top-right': '┐',
    'bottom': '─',
    'bottom-mid': '┴',
    'bottom-left': '└',
    'bottom-right': '┘',
    'left': '│',
    'left-mid': '├',
    'mid': '─',
    'mid-mid': '┼',
    'right': '│',
    'right-mid': '┤',
    'middle': '│'
  };
  var center = [Math.floor(windowSize.width / 2), Math.floor(windowSize.height / 2)];
  var len = 1;
  var direction = [0, -1];
  var position, board;

  function render() {
    rl.output.unmute();
    utils.clearScreen(rl);
    var output = '';
    var top = center[1] - Math.floor(size / 2);
    var left = center[0] - size;
    output += '\n' + repeat(' ', left) + score + '\n';
    output += repeat('\n', top - 2);
    output += repeat(' ', left);
    output += borders['top-left'] + repeat(borders.top, size * 2) + borders['top-right'] + '\n';

    for (var row = 0; row < board.length; row++) {
      output += repeat(' ', left) + borders.left;

      for (var col = 0; col < board[row].length; col++) {
        output += ' ' + board[row][col];
      }

      output += borders.right + '\n';
    }

    output += repeat(' ', left);
    output += borders['bottom-left'] + repeat(borders.bottom, size * 2) + borders['bottom-right'] + '\n';
    rl.output.write(output);
    rl.output.mute();
  }

  function move(event) {
    if (!event) return;

    switch (event.key.name) {
      case 'right':
        direction = [1, 0];
        head = '>';
        break;

      case 'left':
        direction = [-1, 0];
        head = '<';
        break;

      case 'up':
        direction = [0, -1];
        head = '^';
        break;

      case 'down':
        direction = [0, 1];
        head = 'v';
        break;
    }
  }

  function reset() {
    score = 0;
    len = 1;
    body = [];
    position = [Math.floor(size / 2), Math.floor(size / 2)];
    board = new Array(size);

    for (var i = 0; i < board.length; i++) {
      board[i] = new Array(size);

      for (var j = 0; j < board[i].length; j++) {
        board[i][j] = ' ';
      }
    }

    board[position[1]][position[0]] = head;
  }

  function tick() {
    board[position[1]][position[0]] = ' ';
    position[0] += direction[0];
    position[1] += direction[1];

    if (position[0] >= size || position[1] >= size || position[0] < 0 || position[1] < 0) {
      reset();
      return;
    }

    if (board[position[1]][position[0]] === '@') {
      score++;
      len++;

      if (body.length) {
        body.push(position.slice());
      }
    } else if (board[position[1]][position[0]] !== ' ') {
      reset();
      return;
    }

    board[position[1]][position[0]] = head;
    body.reduce(function (acc, curr, i, arr) {
      var tail = 'X';
      var prev = i === 0 ? position : arr[i - 1];
      var next = i === arr.length - 1 ? null : arr[i + 1];

      if (prev[0] === curr[0]) {
        if (next) {
          if (next[0] === curr[0]) tail = borders.middle;else if (next[0] > curr[0]) {
            if (prev[1] < curr[1]) tail = borders['bottom-left'];else tail = borders['top-left'];
          } else {
            if (prev[1] < curr[1]) tail = borders['bottom-right'];else tail = borders['top-right'];
          }
        } else {
          tail = borders.middle;
        }
      } else if (prev[1] === curr[1]) {
        if (next) {
          if (next[1] === curr[1]) tail = borders.mid;else if (next[1] > curr[1]) {
            if (prev[0] > curr[0]) tail = borders['top-left'];else tail = borders['top-right'];
          } else {
            if (prev[0] > curr[0]) tail = borders['bottom-left'];else tail = borders['bottom-right'];
          }
        } else {
          tail = borders.mid;
        }
      }

      board[curr[1]][curr[0]] = tail;
    }, []);
    body.unshift(position.slice());

    while (body.length > len) {
      var part = body.pop();
      board[part[1]][part[0]] = ' ';
    }

    render();
  }

  function apple() {
    var x = Math.floor(Math.random() * size);
    var y = Math.floor(Math.random() * size);
    board[y][x] = emoji;
  }

  var rl = utils.createInterface();
  var width = utils.cliWidth(rl);
  rl.setPrompt('');
  utils.hideCursor(rl);
  rl.input.on('keypress', function (str, key) {
    var event = utils.normalize(str, key);
    move(event);
  });
  rl.on('line', function (line) {
    console.log('line', line);
  });
  rl.output.mute();
  reset();
  render();
  setInterval(tick, 200);
  setInterval(apple, 2000);
};

module.exports = SnakeComp;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIlNuYWtlQ29tcC5qcyJdLCJuYW1lcyI6WyJ1dGlscyIsInJlcXVpcmUiLCJyZXBlYXQiLCJTbmFrZUNvbXAiLCJlbW9qaSIsIndpbmRvd1NpemUiLCJzaXplIiwiaGVpZ2h0Iiwic2NvcmUiLCJoZWFkIiwiYm9keSIsImJvcmRlcnMiLCJjZW50ZXIiLCJNYXRoIiwiZmxvb3IiLCJ3aWR0aCIsImxlbiIsImRpcmVjdGlvbiIsInBvc2l0aW9uIiwiYm9hcmQiLCJyZW5kZXIiLCJybCIsIm91dHB1dCIsInVubXV0ZSIsImNsZWFyU2NyZWVuIiwidG9wIiwibGVmdCIsInJvdyIsImxlbmd0aCIsImNvbCIsInJpZ2h0IiwiYm90dG9tIiwid3JpdGUiLCJtdXRlIiwibW92ZSIsImV2ZW50Iiwia2V5IiwibmFtZSIsInJlc2V0IiwiQXJyYXkiLCJpIiwiaiIsInRpY2siLCJwdXNoIiwic2xpY2UiLCJyZWR1Y2UiLCJhY2MiLCJjdXJyIiwiYXJyIiwidGFpbCIsInByZXYiLCJuZXh0IiwibWlkZGxlIiwibWlkIiwidW5zaGlmdCIsInBhcnQiLCJwb3AiLCJhcHBsZSIsIngiLCJyYW5kb20iLCJ5IiwiY3JlYXRlSW50ZXJmYWNlIiwiY2xpV2lkdGgiLCJzZXRQcm9tcHQiLCJoaWRlQ3Vyc29yIiwiaW5wdXQiLCJvbiIsInN0ciIsIm5vcm1hbGl6ZSIsImxpbmUiLCJjb25zb2xlIiwibG9nIiwic2V0SW50ZXJ2YWwiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFDQSxJQUFJQSxLQUFLLEdBQUdDLE9BQU8sQ0FBQyxnQkFBRCxDQUFuQjs7QUFDQSxJQUFJQyxNQUFNLEdBQUdELE9BQU8sQ0FBQyxlQUFELENBQXBCOztBQUVBLE1BQU1FLFNBQVMsR0FBRyxDQUFDO0FBQUNDLEVBQUFBO0FBQUQsQ0FBRCxLQUFhO0FBQzdCLE1BQUlDLFVBQVUsR0FBR0osT0FBTyxDQUFDLGFBQUQsQ0FBeEI7O0FBQ0EsTUFBSUssSUFBSSxHQUFHRCxVQUFVLENB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QUdyQixLQUFLLENBQUM2RCxlQUFOLEVBQVQ7QUFDQSxNQUFJOUMsS0FBSyxHQUFHZixLQUFLLENBQUM4RCxRQUFOLENBQWV6QyxFQUFmLENBQVo7QUFDQUEsRUFBQUEsRUFBRSxDQUFDMEMsU0FBSCxDQUFhLEVBQWI7QUFDQS9ELEVBQUFBLEtBQUssQ0FBQ2dFLFVBQU4sQ0FBaUIzQyxFQUFqQjtBQUVBQSxFQUFBQSxFQUFFLENBQUM0QyxLQUFILENBQVNDLEVBQVQsQ0FBWSxVQUFaLEVBQXdCLFVBQVNDLEdBQVQsRUFBYy9CLEdBQWQsRUFBbUI7QUFDekMsUUFBSUQsS0FBSyxHQUFHbkMsS0FBSyxDQUFDb0UsU0FBTixDQUFnQkQsR0FBaEIsRUFBcUIvQixHQUFyQixDQUFaO0FBQ0FGLElBQUFBLElBQUksQ0FBQ0MsS0FBRCxDQUFKO0FBQ0QsR0FIRDtBQUtBZCxFQUFBQSxFQUFFLENBQUM2QyxFQUFILENBQU0sTUFBTixFQUFjLFVBQVNHLElBQVQsRUFBZTtBQUMzQkMsSUFBQUEsT0FBTyxDQUFDQyxHQUFSLENBQVksTUFBWixFQUFvQkYsSUFBcEI7QUFDRCxHQUZEO0FBSUFoRCxFQUFBQSxFQUFFLENBQUNDLE1BQUgsQ0FBVVcsSUFBVjtBQUNBSyxFQUFBQSxLQUFLO0FBQ0xsQixFQUFBQSxNQUFNO0FBRU5vRCxFQUFBQSxXQUFXLENBQUM5QixJQUFELEVBQU8sR0FBUCxDQUFYO0FBQ0E4QixFQUFBQSxXQUFXLENBQUNmLEtBQUQsRUFBUSxJQUFSLENBQVg7QUFFRCxDQWpNRDs7QUFtTUFnQixNQUFNLENBQUNDLE9BQVAsR0FBaUJ2RSxTQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcbnZhciB1dGlscyA9IHJlcXVpcmUoJ3JlYWRsaW5lLXV0aWxzJyk7XG52YXIgcmVwZWF0ID0gcmVxdWlyZSgncmVwZWF0LXN0cmluZycpO1xuXG5jb25zdCBTbmFrZUNvbXAgPSAoe2Vtb2ppfSkgPT4ge1xuICB2YXIgd2luZG93U2l6ZSA9IHJlcXVpcmUoJ3dpbmRvdy1zaXplJyk7XG4gIHZhciBzaXplID0gd2luZG93U2l6ZS5oZWlnaHQgLSAxMDtcbiAgdmFyIHNjb3JlID0gMDtcbiAgdmFyIGhlYWQgPSAnXic7XG4gIHZhciBib2R5ID0gW107XG5cbiAgLy8gYm9yZGVycyBhcmUgZnJvbSBjbGktdGFibGUgY2hhcnM6IGh0dHBzOi8vZ2l0aHViLmNvbS9BdXRvbWF0dGljL2NsaS10YWJsZS9ibG9iL21hc3Rlci9saWIvaW5kZXguanMjTDIxLUwzN1xuICB2YXIgYm9yZGVycyA9IHtcbiAgICAndG9wJzogJ+KUgCcsXG4gICAgJ3RvcC1taWQnOiAn4pSsJyxcbiAgICAndG9wLWxlZnQnOiAn4pSMJyxcbiAgICAndG9wLXJpZ2h0JzogJ+KUkCcsXG4gICAgJ2JvdHRvbSc6ICfilIAnLFxuICAgICdib3R0b20tbWlkJzogJ+KUtCcsXG4gICAgJ2JvdHRvbS1sZWZ0JzogJ+KUlCcsXG4gICAgJ2JvdHRvbS1yaWdodCc6ICfilJgnLFxuICAgICdsZWZ0JzogJ+KUgicsXG4gICAgJ2xlZnQtbWlkJzogJ+KUnCcsXG4gICAgJ21pZCc6ICfilIAnLFxuICAgICdtaWQtbWlkJzogJ+KUvCcsXG4gICAgJ3JpZ2h0JzogJ+KUgicsXG4gICAgJ3JpZ2h0LW1pZCc6ICfilKQnLFxuICAgICdtaWRkbGUnOiAn4pSCJ1xuICB9O1xuXG4gIHZhciBjZW50ZXIgPSBbXG4gICAgTWF0aC5mbG9vcih3aW5kb3dTaXplLndpZHRoIC8gMiksXG4gICAgTWF0aC5mbG9vcih3aW5kb3dTaXplLmhlaWdodCAvIDIpXG4gIF07XG5cbiAgdmFyIGxlbiA9IDE7XG4gIHZhciBkaXJlY3Rpb24gPSBbMCwgLTFdO1xuICB2YXIgcG9zaXRpb24sIGJvYXJkO1xuXG4gIGZ1bmN0aW9uIHJlbmRlcigpIHtcbiAgICBybC5vdXRwdXQudW5tdXRlKCk7XG4gICAgdXRpbHMuY2xlYXJTY3JlZW4ocmwpO1xuXG4gICAgdmFyIG91dHB1dCA9ICcnO1xuICAgIHZhciB0b3AgPSBjZW50ZXJbMV0gLSBNYXRoLmZsb29yKHNpemUgLyAyKTtcbiAgICB2YXIgbGVmdCA9IGNlbnRlclswXSAtIHNpemU7XG4gICAgb3V0cHV0ICs9ICdcXG4nICsgcmVwZWF0KCcgJywgbGVmdCkgKyBzY29yZSArICdcXG4nO1xuICAgIG91dHB1dCArPSByZXBlYXQoJ1xcbicsIHRvcCAtIDIpO1xuICAgIG91dHB1dCArPSByZXBlYXQoJyAnLCBsZWZ0KTtcbiAgICBvdXRwdXQgKz0gYm9yZGVyc1sndG9wLWxlZnQnXSArIHJlcGVhdChib3JkZXJzLnRvcCwgKHNpemUgKiAyKSkgKyBib3JkZXJzWyd0b3AtcmlnaHQnXSArICdcXG4nO1xuXG4gICAgZm9yICh2YXIgcm93ID0gMDsgcm93IDwgYm9hcmQubGVuZ3RoOyByb3crKykge1xuICAgICAgb3V0cHV0ICs9IHJlcGVhdCgnICcsIGxlZnQpICsgYm9yZGVycy5sZWZ0O1xuICAgICAgZm9yICh2YXIgY29sID0gMDsgY29sIDwgYm9hcmRbcm93XS5sZW5ndGg7IGNvbCsrKSB7XG4gICAgICAgIG91dHB1dCArPSAnICcgKyBib2FyZFtyb3ddW2NvbF07XG4gICAgICB9XG4gICAgICBvdXRwdXQgKz0gYm9yZGVycy5yaWdodCArICdcXG4nO1xuICAgIH1cbiAgICBvdXRwdXQgKz0gcmVwZWF0KCcgJywgbGVmdCk7XG4gICAgb3V0cHV0ICs9IGJvcmRlcnNbJ2JvdHRvbS1sZWZ0J10gKyByZXBlYXQoYm9yZGVycy5ib3R0b20sIChzaXplICogMikpICsgYm9yZGVyc1snYm90dG9tLXJpZ2h0J10gKyAnXFxuJztcblxuICAgIHJsLm91dHB1dC53cml0ZShvdXRwdXQpO1xuICAgIHJsLm91dHB1dC5tdXRlKCk7XG4gIH1cblxuICBmdW5jdGlvbiBtb3ZlKGV2ZW50KSB7XG4gICAgaWYgKCFldmVudCkgcmV0dXJuO1xuICAgIHN3aXRjaCAoZXZlbnQua2V5Lm5hbWUpIHtcbiAgICAgIGNhc2UgJ3JpZ2h0JzpcbiAgICAgICAgZGlyZWN0aW9uID0gWzEsIDBdO1xuICAgICAgICBoZWFkID0gJz4nO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ2xlZnQnOlxuICAgICAgICBkaXJlY3Rpb24gPSBbLTEsIDBdO1xuICAgICAgICBoZWFkID0gJzwnO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ3VwJzpcbiAgICAgICAgZGlyZWN0aW9uID0gWzAsIC0xXTtcbiAgICAgICAgaGVhZCA9ICdeJztcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdkb3duJzpcbiAgICAgICAgZGlyZWN0aW9uID0gWzAsIDFdO1xuICAgICAgICBoZWFkID0gJ3YnO1xuICAgICAgICBicmVhaztcbiAgICB9XG4gIH1cblxuICBmdW5jdGlvbiByZXNldCgpIHtcbiAgICBzY29yZSA9IDA7XG4gICAgbGVuID0gMTtcbiAgICBib2R5ID0gW107XG4gICAgcG9zaXRpb24gPSBbXG4gICAgICBNYXRoLmZsb29yKHNpemUgLyAyKSxcbiAgICAgIE1hdGguZmxvb3Ioc2l6ZSAvIDIpXG4gICAgXTtcblxuICAgIGJvYXJkID0gbmV3IEFycmF5KHNpemUpO1xuICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYm9hcmQubGVuZ3RoOyBpKyspIHtcbiAgICAgIGJvYXJkW2ldID0gbmV3IEFycmF5KHNpemUpO1xuICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBib2FyZFtpXS5sZW5ndGg7IGorKykge1xuICAgICAgICBib2FyZFtpXVtqXSA9ICcgJztcbiAgICAgIH1cbiAgICB9XG4gICAgYm9hcmRbcG9zaXRpb25bMV1dW3Bvc2l0aW9uWzBdXSA9IGhlYWQ7XG4gIH1cblxuICBmdW5jdGlvbiB0aWNrKCkge1xuICAgIGJvYXJkW3Bvc2l0aW9uWzFdXVtwb3NpdGlvblswXV0gPSAnICc7XG4gICAgcG9zaXRpb25bMF0gKz0gZGlyZWN0aW9uWzBdO1xuICAgIHBvc2l0aW9uWzFdICs9IGRpcmVjdGlvblsxXTtcblxuICAgIGlmIChwb3NpdGlvblswXSA+PSBzaXplIHx8IHBvc2l0aW9uWzFdID49IHNpemUgfHwgcG9zaXRpb25bMF0gPCAwIHx8IHBvc2l0aW9uWzFdIDwgMCkge1xuICAgICAgcmVzZXQoKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAoYm9hcmRbcG9zaXRpb25bMV1dW3Bvc2l0aW9uWzBdXSA9PT0gJ0AnKSB7XG4gICAgICBzY29yZSsrO1xuICAgICAgbGVuKys7XG4gICAgICBpZiAoYm9keS5sZW5ndGgpIHtcbiAgICAgICAgYm9keS5wdXNoKHBvc2l0aW9uLnNsaWNlKCkpO1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAoYm9hcmRbcG9zaXRpb25bMV1dW3Bvc2l0aW9uWzBdXSAhPT0gJyAnKSB7XG4gICAgICByZXNldCgpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGJvYXJkW3Bvc2l0aW9uWzFdXVtwb3NpdGlvblswXV0gPSBoZWFkO1xuICAgIGJvZHkucmVkdWNlKGZ1bmN0aW9uKGFjYywgY3VyciwgaSwgYXJyKSB7XG4gICAgICB2YXIgdGFpbCA9ICdYJztcbiAgICAgIHZhciBwcmV2ID0gKGkgPT09IDAgPyBwb3NpdGlvbiA6IGFycltpIC0gMV0pO1xuICAgICAgdmFyIG5leHQgPSAoaSA9PT0gYXJyLmxlbmd0aCAtIDEgPyBudWxsIDogYXJyW2kgKyAxXSk7XG4gICAgICBpZiAocHJldlswXSA9PT0gY3VyclswXSkge1xuICAgICAgICBpZiAobmV4dCkge1xuICAgICAgICAgIGlmIChuZXh0WzBdID09PSBjdXJyWzBdKSB0YWlsID0gYm9yZGVycy5taWRkbGU7XG4gICAgICAgICAgZWxzZSBpZiAobmV4dFswXSA+IGN1cnJbMF0pIHtcbiAgICAgICAgICAgIGlmIChwcmV2WzFdIDwgY3VyclsxXSkgdGFpbCA9IGJvcmRlcnNbJ2JvdHRvbS1sZWZ0J107XG4gICAgICAgICAgICBlbHNlIHRhaWwgPSBib3JkZXJzWyd0b3AtbGVmdCddO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAocHJldlsxXSA8IGN1cnJbMV0pIHRhaWwgPSBib3JkZXJzWydib3R0b20tcmlnaHQnXTtcbiAgICAgICAgICAgIGVsc2UgdGFpbCA9IGJvcmRlcnNbJ3RvcC1yaWdodCddO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0YWlsID0gYm9yZGVycy5taWRkbGU7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSBpZiAocHJldlsxXSA9PT0gY3VyclsxXSkge1xuICAgICAgICBpZiAobmV4dCkge1xuICAgICAgICAgIGlmIChuZXh0WzFdID09PSBjdXJyWzFdKSB0YWlsID0gYm9yZGVycy5taWQ7XG4gICAgICAgICAgZWxzZSBpZiAobmV4dFsxXSA+IGN1cnJbMV0pIHtcbiAgICAgICAgICAgIGlmIChwcmV2WzBdID4gY3VyclswXSkgdGFpbCA9IGJvcmRlcnNbJ3RvcC1sZWZ0J107XG4gICAgICAgICAgICBlbHNlIHRhaWwgPSBib3JkZXJzWyd0b3AtcmlnaHQnXTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKHByZXZbMF0gPiBjdXJyWzBdKSB0YWlsID0gYm9yZGVyc1snYm90dG9tLWxlZnQnXTtcbiAgICAgICAgICAgIGVsc2UgdGFpbCA9IGJvcmRlcnNbJ2JvdHRvbS1yaWdodCddO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0YWlsID0gYm9yZGVycy5taWQ7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGJvYXJkW2N1cnJbMV1dW2N1cnJbMF1dID0gdGFpbDtcbiAgICB9LCBbXSk7XG5cbiAgICBib2R5LnVuc2hpZnQocG9zaXRpb24uc2xpY2UoKSk7XG4gICAgd2hpbGUgKGJvZHkubGVuZ3RoID4gbGVuKSB7XG4gICAgICB2YXIgcGFydCA9IGJvZHkucG9wKCk7XG4gICAgICBib2FyZFtwYXJ0WzFdXVtwYXJ0WzBdXSA9ICcgJztcbiAgICB9XG4gICAgcmVuZGVyKCk7XG4gIH1cblxuICBmdW5jdGlvbiBhcHBsZSgpIHtcbiAgICB2YXIgeCA9IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIHNpemUpO1xuICAgIHZhciB5ID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogc2l6ZSk7XG4gICAgYm9hcmRbeV1beF0gPSBlbW9qaTtcbiAgfVxuXG4gIHZhciBybCA9IHV0aWxzLmNyZWF0ZUludGVyZmFjZSgpO1xuICB2YXIgd2lkdGggPSB1dGlscy5jbGlXaWR0aChybCk7XG4gIHJsLnNldFByb21wdCgnJyk7XG4gIHV0aWxzLmhpZGVDdXJzb3IocmwpO1xuXG4gIHJsLmlucHV0Lm9uKCdrZXlwcmVzcycsIGZ1bmN0aW9uKHN0ciwga2V5KSB7XG4gICAgdmFyIGV2ZW50ID0gdXRpbHMubm9ybWFsaXplKHN0ciwga2V5KTtcbiAgICBtb3ZlKGV2ZW50KTtcbiAgfSk7XG5cbiAgcmwub24oJ2xpbmUnLCBmdW5jdGlvbihsaW5lKSB7XG4gICAgY29uc29sZS5sb2coJ2xpbmUnLCBsaW5lKTtcbiAgfSk7XG5cbiAgcmwub3V0cHV0Lm11dGUoKTtcbiAgcmVzZXQoKTtcbiAgcmVuZGVyKCk7XG5cbiAgc2V0SW50ZXJ2YWwodGljaywgMjAwKTtcbiAgc2V0SW50ZXJ2YWwoYXBwbGUsIDIwMDApO1xuXG59O1xuXG5tb2R1bGUuZXhwb3J0cyA9IFNuYWtlQ29tcDtcbiJdfQ==